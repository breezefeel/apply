<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>리:얼 커뮤니티센터 회원 신청</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			-webkit-tap-highlight-color: transparent;
		}
		
		body {
			font-family: 'Malgun Gothic', -apple-system, BlinkMacSystemFont, sans-serif;
			/* 배경을 그린/틸 계열로 변경 */
			background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
			min-height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 20px;
			touch-action: pan-y;
		}
		
		.container {
			max-width: 700px;
			margin: 0 auto;
			width: 100%;
		}
		
		.card {
			background: white;
			border-radius: 20px;
			padding: 40px;
			box-shadow: 0 20px 60px rgba(0,0,0,0.3);
			display: none;
			animation: slideIn 0.5s ease;
		}
		
		.card.active {
			display: block;
		}
		
		@keyframes slideIn {
			from {
				opacity: 0;
				transform: translateY(20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		.card-header {
			text-align: center;
			margin-bottom: 30px;
		}
		
		.card-number {
			display: inline-block;
			/* 색상 변경 */
			background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
			color: white;
			padding: 8px 20px;
			border-radius: 20px;
			font-size: 14px;
			font-weight: bold;
			margin-bottom: 15px;
		}
		
		.card-title {
			font-size: 28px;
			font-weight: bold;
			color: #00b09b;
			margin-bottom: 10px;
		}
		
		.card-subtitle {
			text-align: center;
            color: #ff6b6b; /* 필수 요소 강조 색상 (빨간색) */
            margin-bottom: 30px;
            font-size: 16px;
            font-weight: 600;
        }
					
        .divider {
            text-align: center;
            color: #ddd;
            margin-bottom: 30px;
            letter-spacing: 2px;
        }
		/* index (7).html의 <style> 블록에 추가 */
		.main-title {
			text-align: center;
			/* 색상 변경 */
			color: #00b09b;
			margin-bottom: 30px;
			font-size: 32px;
		}
		
		.form-group {
			margin-bottom: 25px;
		}
		
		.form-label {
			display: block;
			font-weight: bold;
			color: #555;
			margin-bottom: 10px;
			font-size: 15px;
		}
		
		.form-input {
			width: 100%;
			padding: 22px;
			border: 2px solid #e0e0e0;
			border-radius: 10px;
			font-size: 16px;
			transition: all 0.3s;
			min-height: 75px; /* 페이지2 select 기본 높이 */
		}
		
		/* 페이지1 입력 필드는 작게 */
		#page1 .form-input {
			padding: 12px;
			min-height: 50px;
		}
		
		/* 페이지2 select는 모바일에서 더 크게 */
		#page2 select.form-input {
			padding: 24px;
			min-height: 80px;
		}
		
		@media (min-width: 768px) {
			#page2 select.form-input {
				padding: 15px;
				min-height: 54px;
			}
		}
		
		.form-input:focus {
			outline: none;
			/* 색상 변경 */
			border-color: #00b09b;
			/* 색상 변경 (RGB: 0, 176, 155) */
			box-shadow: 0 0 0 3px rgba(0, 176, 155, 0.1);
		}
		
		.select-group {
			display: flex;
			gap: 10px;
		}
		
		.select-group select {
			flex: 1;
			padding: 25px 15px;
			border: 2px solid #e0e0e0;
			border-radius: 10px;
			font-size: 18px;
			background: white;
			font-weight: 600;
		}
		
		.program-option {
			margin-bottom: 15px;
		}
		
		/* 프로그램 선택을 한 줄에 배치 */
		.program-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 15px;
		}
		
		.program-grid .program-option {
			margin-bottom: 0;
		}
		
		.program-option input[type="radio"] {
			display: none;
		}
		
		.program-option label {
			display: block;
			padding: 20px;
			border: 2px solid #e0e0e0;
			border-radius: 10px;
			cursor: pointer;
			transition: all 0.3s;
		}
		
		.program-option input[type="radio"]:checked + label {
			/* 색상 변경 */
			background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
			color: white;
			/* 색상 변경 */
			border-color: #00b09b;
		}
		
		.program-option input[type="radio"]:checked + label .program-desc {
			color: white;
			opacity: 1;
		}
		
		.program-option input[type="radio"]:checked + label strong {
			color: white !important;
		}
		
		.program-name {
			font-size: 18px;
			font-weight: bold;
			margin-bottom: 5px;
		}

		/* 1. 왼쪽 메뉴 (P-스트레칭) - 색상 변경 */
		#programSelectionGroup .program-option:nth-child(1) .program-name {
			color: #5185D4 !important; 
		}

		/* 2. 오른쪽 메뉴 (작은얼굴) - 색상 변경 */
		#programSelectionGroup .program-option:nth-child(2) .program-name {
			color: #EA580C !important; 
		}

		/* 3. 선택되었을 때 흰색을 유지하는 규칙 (범위 좁히기) */
		#programSelectionGroup .program-option input[type="radio"]:checked + label .program-name {
			color: white !important;
		}
		
		.program-desc {
			font-size: 13px;
			opacity: 0.8;
		}
		
		/* 결제 금액 선택 스타일 */
		#amountGroup {
			border-top: 2px solid #e0e0e0;
			padding-top: 25px;
			margin-top: 25px;
		}
		
		/* 직접 입력 메뉴만 높이 줄이기 */
		#customAmount + label {
			padding: 15px 20px !important;
		}
		.amount-option {
			margin-bottom: 15px;
		}
		
		.amount-option input[type="radio"] {
			display: none;
		}
		
		.amount-option label {
			display: block;
			padding: 20px;
			border: 2px solid #e0e0e0;
			border-radius: 10px;
			cursor: pointer;
			transition: all 0.3s;
			position: relative;
		}
		
		.amount-option input[type="radio"]:checked + label {
			/* 색상 변경 */
			background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
			color: white;
			/* 색상 변경 */
			border-color: #00b09b;
		}
		
		.amount-name {
			font-size: 16px;
			font-weight: bold;
			margin-bottom: 8px;
		}
		
		.amount-price {
			font-size: 24px;
			font-weight: bold;
			margin-bottom: 5px;
			/* 색상 변경 */
			color: #00b09b;
		}
		
		.amount-option input[type="radio"]:checked + label .amount-price {
			color: white;
		}
		
		.amount-desc {
			font-size: 13px;
			opacity: 0.7;
		}
		
		.weekday-grid {
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			gap: 10px;
		}
		
		.weekday-option {
			position: relative;
		}
		
		.weekday-option input[type="checkbox"] {
			display: none;
		}
		
		.weekday-option label {
			display: block;
			padding: 15px 10px;
			border: 2px solid #e0e0e0;
			border-radius: 10px;
			text-align: center;
			cursor: pointer;
			transition: all 0.3s;
			font-weight: 500;
			font-size: 14px;
		}
		
		.weekday-option input[type="checkbox"]:checked + label {
			/* 색상 변경 */
			background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
			color: white;
			/* 색상 변경 */
			border-color: #00b09b;
		}
		
		.terms-box {
			background: #f8f9fa;
			border-radius: 10px;
			padding: 20px;
			max-height: 300px;
			overflow-y: auto;
			margin-bottom: 20px;
			font-size: 13px;
			line-height: 1.8;
			transition: all 0.5s ease;
		}
		
		.terms-box.collapsed {
			max-height: 100px;
			overflow: hidden;
		}
		
		.terms-box h4 {
			color: #333;
			margin: 15px 0 10px 0;
			font-size: 14px;
		}
		
		.terms-box ol {
			padding-left: 20px;
		}
		
		.terms-box li {
			margin-bottom: 10px;
		}
		
		.privacy-box {
			background: #f8f9fa;
			border-radius: 10px;
			padding: 20px;
			max-height: 0;
			overflow: hidden;
			margin-bottom: 20px;
			font-size: 13px;
			line-height: 1.8;
			transition: all 0.5s ease;
			opacity: 0;
		}
		
		.privacy-box.expanded {
			max-height: 500px;
			opacity: 1;
			overflow-y: auto;
		}
		
		.privacy-box.collapsed {
			max-height: 100px;
			opacity: 1;
			overflow: hidden;
		}
		
		.checkbox-group {
			margin-bottom: 20px;
		}
		
		.checkbox-option {
			display: flex;
			align-items: center;
			padding: 15px;
			border: 2px solid #e0e0e0;
			border-radius: 10px;
			margin-bottom: 10px;
			cursor: pointer;
			transition: all 0.3s;
		}
		
		.checkbox-option.checked {
			/* 색상 변경 (라이트 블루 -> 라이트 틸) */
			background: #e0f7fa; 
			/* 색상 변경 */
			border-color: #00b09b;
		}
		
		.checkbox-option input[type="checkbox"] {
			width: 20px;
			height: 20px;
			margin-right: 10px;
			cursor: pointer;
		}
		
		.checkbox-option label {
			cursor: pointer;
			font-weight: 500;
			flex: 1;
		}
		
		.signature-pad {
			/* 색상 변경 */
			border: 2px dashed #00b09b;
			/* 색상 변경 (라이트 퍼플 -> 라이트 블루/틸) */
			background: #f0f7ff; 
			border-radius: 10px;
			margin-bottom: 10px;
			position: relative;
			overflow: hidden;
		}
		
		.signature-canvas {
			display: block;
			width: 100%;
			height: 200px;
			touch-action: none;
			cursor: crosshair;
		}
		
		.signature-clear {
			display: block;
			width: 100%;
			padding: 10px;
			background: #f0f0f0;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			margin-bottom: 20px;
		}
		
		.signature-help {
			text-align: center;
			/* 색상 변경 */
			color: #00b09b;
			font-size: 13px;
			margin-bottom: 10px;
			font-weight: 500;
		}
		
		.button-group {
			display: flex;
			gap: 10px;
			margin-top: 30px;
		}
		
		.btn {
			flex: 1;
			padding: 18px;
			border: none;
			border-radius: 10px;
			font-size: 16px;
			font-weight: bold;
			cursor: pointer;
			transition: all 0.3s;
		}
		
		.btn-prev {
			background: #e0e0e0;
			color: #666;
		}
		
		.btn-prev:hover {
			background: #d0d0d0;
		}
		
		.btn-next {
			/* 색상 변경 */
			background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
			color: white;
		}
		
		.btn-next:hover {
			transform: translateY(-2px);
			/* 색상 변경 (RGB: 0, 176, 155) */
			box-shadow: 0 5px 20px rgba(0, 176, 155, 0.4);
		}
		
		.btn-next:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		
		/* 반응형 최종 페이지 */
		.final-page {
			background: white;
			max-width: 900px;
			width: 100%;
			padding: 20px;
			padding-bottom: 80px;
			border-radius: 20px;
			box-shadow: 0 20px 60px rgba(0,0,0,0.3);
		}

		@media (min-width: 768px) {
			.final-page {
				padding: 40px;
				padding-bottom: 100px;
			}
		}
		
		/* 반응형 문서 미리보기 */
		.document-preview {
			background: white;
			padding: 15px;
			border-radius: 10px;
			margin-bottom: 20px;
			overflow-x: auto;
		}

		@media (min-width: 768px) {
			.document-preview {
				padding: 30px;
			}
		}
		
		/* A4 크기 문서 스타일 (캡처용, 화면에는 숨김) */
		.a4-document {
			position: absolute;
			left: -9999px; 	/* 화면 밖으로 숨김 */
			top: 0;
			width: 794px !important;
			height: auto !important;
			min-width: 794px;
			min-height: 1123px;
			max-width: 794px;
			padding: 6mm 8mm;
			padding-bottom: 8mm;
			background: white;
			box-sizing: border-box;
			font-family: 'Malgun Gothic', sans-serif;
			overflow: visible;
			transform: scale(0.95); 
			transform-origin: top left;
		}
		
		.document-title {
			text-align: center;
			font-size: 12px;
			font-weight: bold;
			margin-bottom: 3px;
		}

		@media (min-width: 768px) {
			.document-title {
				font-size: 22px;
				margin-bottom: 20px;
			}
		}
		
		.info-table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 3px;
			font-size: 7px;
			line-height: 1.5;
		}

		@media (min-width: 768px) {
			.info-table {
				margin-bottom: 15px;
				font-size: 12px;
			}
		}
		
		.info-table td {
			border: 2px solid #000;
			padding: 2px;
		}

		@media (min-width: 768px) {
			.info-table td {
				padding: 8px;
			}
		}
		
		.info-table .label {
			background-color: #e8e8e8;
			width: 60px;
			text-align: center;
			font-weight: bold;
		}

		@media (min-width: 768px) {
			.info-table .label {
				width: 100px;
			}
		}
		
		.application-section {
			border: 2px solid #000;
			padding: 2.5px;
			margin-bottom: 3px;
		}

		@media (min-width: 768px) {
			.application-section {
				padding: 12px;
				margin-bottom: 15px;
			}
		}
		
		.section-title {
			text-align: center;
			font-weight: bold;
			font-size: 8.5px;
			margin-bottom: 2px;
		}

		@media (min-width: 768px) {
			.section-title {
				font-size: 15px;
				margin-bottom: 10px;
			}
		}
		
		.agreement-title {
			text-align: center;
			font-size: 7.5px;
			font-weight: bold;
			margin: 3px 0 2px 0;
		}

		@media (min-width: 768px) {
			.agreement-title {
				font-size: 14px;
				margin: 15px 0 12px 0;
			}
		}
		
		.agreement-list {
			line-height: 1.5;
			margin-bottom: 2.5px;
			font-size: 6px;
		}

		@media (min-width: 768px) {
			.agreement-list {
				line-height: 1.7;
				margin-bottom: 12px;
				font-size: 11px;
			}
		}
		
		.agreement-list li {
			margin-bottom: 1px;
		}

		@media (min-width: 768px) {
			.agreement-list li {
				margin-bottom: 5px;
			}
		}
		
		.note-box {
			text-align: center;
			font-size: 6.5px;
			font-weight: bold;
			margin: 3px 0;
			padding: 2.5px;
			border: 1px solid #333;
		}

		@media (min-width: 768px) {
			.note-box {
				font-size: 14px;
				margin: 20px 0;
				padding: 12px;
			}
		}
		
		/* 서명 관련 스타일 조정 */
		.signature-in-note {
			display: inline-block;
			width: 100px; 	/* 70px에서 증가 */
			border-bottom: 1px solid #333;
			vertical-align: middle;
			height: 25px; 	/* 18px에서 증가 */
			position: relative;
		}

		@media (min-width: 768px) {
			.signature-in-note {
				width: 120px;
				height: 35px;
			}
		}
		
		.signature-in-note img {
			position: absolute;
			bottom: 0;
			left: 50%;
			transform: translateX(-50%);
			height: 22px; 	/* 16px에서 증가 */
			max-width: 95px;
			object-fit: contain;
		}

		@media (min-width: 768px) {
			.signature-in-note img {
				height: 30px;
			}
		}
		
		.detailed-agreement {
			margin-top: 2.5px;
			font-size: 5.2px;
			line-height: 1.5;
		}

		@media (min-width: 768px) {
			.detailed-agreement {
				margin-top: 12px;
				font-size: 10px;
				line-height: 1.6;
			}
		}
		
		.detailed-agreement h3 {
			font-size: 6px;
			font-weight: bold;
			margin: 2px 0 1px 0;
		}

		@media (min-width: 768px) {
			.detailed-agreement h3 {
				font-size: 12px;
				margin: 10px 0 6px 0;
			}
		}
		
		.detailed-agreement p,
		.detailed-agreement li {
			margin-bottom: 2px;
		}

		@media (min-width: 768px) {
			.detailed-agreement p,
			.detailed-agreement li {
				margin-bottom: 6px;
			}
		}
		
		.consent-box {
			border: 2px solid #000;
			padding: 10px;
			margin-top: 15px;
			margin-bottom: 15px;
		}

		@media (min-width: 768px) {
			.consent-box {
				padding: 15px;
				margin-top: 20px;
			}
		}
		
		.consent-box h3 {
			text-align: center;
			font-size: 9px;
			font-weight: bold;
			margin-bottom: 4px;
		}

		@media (min-width: 768px) {
			.consent-box h3 {
				font-size: 14px;
				margin-bottom: 12px;
			}
		}
		
		.consent-box p {
			line-height: 1.3;
			text-align: center;
			font-size: 7.5px;
		}

		@media (min-width: 768px) {
			.consent-box p {
				line-height: 1.6;
				font-size: 12px;
			}
		}
		
		.signature-section {
			margin-top: 20px;
			margin-bottom: 20px;
			text-align: center;
			page-break-inside: avoid;
		}

		@media (min-width: 768px) {
			.signature-section {
				margin-top: 30px;
			}
		}
		
		.signature-line {
			display: inline-block;
			margin: 6px 12px;
		}

		@media (min-width: 768px) {
			.signature-line {
				margin: 15px 30px;
			}
		}
		
		.signature-line label {
			font-weight: bold;
			margin-right: 3px;
			font-size: 8px;
		}

		@media (min-width: 768px) {
			.signature-line label {
				margin-right: 8px;
				font-size: 13px;
			}
		}
		
		.signature-display {
			display: inline-block;
			border: none;
			border-bottom: 2px solid #000;
			padding: 2px;
			min-width: 120px;
		}
		
		.signature-display img {
			height: 40px;
			max-width: 150px;
			vertical-align: middle;
			object-fit: contain;
		}

		@media (min-width: 768px) {
			.signature-display img {
				height: 50px;
				max-width: 180px;
			}
		}
		
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.8);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 9999;
		}

		.loading-overlay.active {
			display: flex;
		}

		.loading-content {
			background: white;
			padding: 40px;
			border-radius: 20px;
			text-align: center;
			max-width: 400px;
		}

		.spinner {
			border: 4px solid #f3f3f3;
			/* 색상 변경 */
			border-top: 4px solid #00b09b;
			border-radius: 50%;
			width: 50px;
			height: 50px;
			animation: spin 1s linear infinite;
			margin: 0 auto 20px;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		.success-box {
			background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
			color: white;
			padding: 25px;
			border-radius: 15px;
			margin-bottom: 25px;
			text-align: center;
		}

		@media (min-width: 768px) {
			.success-box {
				padding: 30px;
				margin-bottom: 30px;
			}
		}

		.success-box h2 {
			font-size: 20px;
			margin-bottom: 12px;
		}

		@media (min-width: 768px) {
			.success-box h2 {
				font-size: 24px;
				margin-bottom: 15px;
			}
		}

		.success-box p {
			font-size: 14px;
			opacity: 0.95;
			line-height: 1.6;
		}

		@media (min-width: 768px) {
			.success-box p {
				font-size: 16px;
			}
		}

		.drive-btn {
			/* 색상 변경 */
			background: #00b09b;
			color: white;
			padding: 18px;
			border: none;
			border-radius: 10px;
			font-size: 16px;
			font-weight: bold;
			cursor: pointer;
			width: 100%;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 10px;
			transition: all 0.3s;
			margin-bottom: 15px;
		}

		@media (min-width: 768px) {
			.drive-btn {
				padding: 20px;
				font-size: 18px;
			}
		}

		.drive-btn:hover {
			transform: translateY(-2px);
			/* 색상 변경 (RGB: 0, 176, 155) */
			box-shadow: 0 5px 20px rgba(0, 176, 155, 0.4);
		}

		.download-btn {
			/* 색상 변경 */
			background: #009684;
			color: white;
			padding: 18px;
			border: none;
			border-radius: 10px;
			font-size: 16px;
			font-weight: bold;
			cursor: pointer;
			width: 100%;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 10px;
			transition: all 0.3s;
		}

		@media (min-width: 768px) {
			.download-btn {
				padding: 20px;
				font-size: 18px;
			}
		}

		.download-btn:hover {
			transform: translateY(-2px);
			/* 색상 변경 (RGB: 0, 150, 132) */
			box-shadow: 0 5px 20px rgba(0, 150, 132, 0.4);
		}

		.progress-bar {
			display: flex;
			justify-content: center;
			gap: 10px;
			margin-bottom: 30px;
		}
		
		.progress-dot {
			width: 12px;
			height: 12px;
			border-radius: 50%;
			background: #e0e0e0;
			transition: all 0.3s;
		}
		
		.progress-dot.active {
			/* 색상 변경 */
			background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
			width: 30px;
			border-radius: 10px;
		}

		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.9);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 10000;
			padding: 20px;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
		}
		
		.modal-overlay.active {
			display: flex;
		}
		
		.modal-content {
			background: white;
			padding: 30px;
			border-radius: 20px;
			text-align: center;
			max-width: 450px;
			width: 100%;
			position: relative;
			pointer-events: auto;
		}

		@media (min-width: 768px) {
			.modal-content {
				padding: 40px;
			}
		}

		.modal-icon {
			font-size: 48px;
			margin-bottom: 15px;
		}

		@media (min-width: 768px) {
			.modal-icon {
				font-size: 64px;
				margin-bottom: 20px;
			}
		}

		.modal-title {
			font-size: 20px;
			font-weight: bold;
			color: #333;
			margin-bottom: 12px;
		}

		@media (min-width: 768px) {
			.modal-title {
				font-size: 24px;
				margin-bottom: 15px;
			}
		}

		.modal-message {
			font-size: 14px;
			color: #666;
			line-height: 1.6;
			margin-bottom: 20px;
		}

		@media (min-width: 768px) {
			.modal-message {
				font-size: 16px;
				margin-bottom: 25px;
			}
		}

		.modal-btn {
			width: 100%;
			padding: 16px;
			border: none;
			border-radius: 10px;
			font-size: 16px;
			font-weight: bold;
			cursor: pointer;
			/* 색상 변경 */
			background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
			color: white;
			transition: all 0.3s;
			margin-bottom: 10px;
		}

		@media (min-width: 768px) {
			.modal-btn {
				padding: 18px;
				font-size: 18px;
			}
		}

		.modal-btn:hover {
			transform: translateY(-2px);
			/* 색상 변경 (RGB: 0, 176, 155) */
			box-shadow: 0 5px 20px rgba(0, 176, 155, 0.4);
		}

		.modal-btn.secondary {
			background: #e0e0e0;
			color: #666;
		}

		.modal-btn.secondary:hover {
			background: #d0d0d0;
			box-shadow: none;
		}

		.help-note {
			/* 색상 변경 (라이트 블루 -> 라이트 틸) */
			background: #e0f7fa;
			/* 색상 변경 (블루 -> 시안/틸) */
			border: 2px solid #00bcd4;
			border-radius: 10px;
			padding: 15px;
			margin-bottom: 20px;
			text-align: left;
		}

		.help-note-title {
			font-weight: bold;
			/* 색상 변경 (다크 블루 -> 다크 시안/틸) */
			color: #00838f;
			margin-bottom: 8px;
			font-size: 14px;
		}

		.help-note-text {
			/* 색상 변경 (다크 블루 -> 다크 시안/틸) */
			color: #00838f;
			font-size: 13px;
			line-height: 1.6;
		}

		.file-preview {
			border: 2px solid #e0e0e0;
			border-radius: 10px;
			padding: 15px;
			margin-top: 15px;
			text-align: center;
		}

		.file-preview img {
			max-width: 100%;
			border-radius: 8px;
			margin-bottom: 10px;
		}

		.view-file-btn {
			/* 색상 변경 */
			background: #00b09b;
			color: white;
			padding: 12px 20px;
			border: none;
			border-radius: 8px;
			font-size: 14px;
			font-weight: bold;
			cursor: pointer;
			transition: all 0.3s;
		}

		.view-file-btn:hover {
			transform: translateY(-2px);
			/* 색상 변경 (RGB: 0, 176, 155) */
			box-shadow: 0 3px 15px rgba(0, 176, 155, 0.3);
		}
	</style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">신청서를 생성하는 중...</p>
        </div>
    </div>

    <div class="modal-overlay" id="downloadModal">
        <div class="modal-content">
            <div class="modal-icon">📥</div>
            <h2 class="modal-title">다운로드 완료!</h2>
            
            <div class="help-note">
                <div class="help-note-title">💡 갤러리/사진첩 저장 방법</div>
                <div class="help-note-text">
                    <strong>1단계:</strong> 다운로드한 파일 열기<br>
                    <strong>2단계:</strong> 저장 or 공유 버튼 클릭<br>
                    <strong>3단계:</strong> "이미지 저장" 또는 "갤러리에 저장" 선택
                </div>
            </div>

            <div class="file-preview" id="filePreview">
                <p style="color: #666; margin-bottom: 10px;">다운로드한 파일:</p>
                <img id="previewImage" src="" alt="신청서 미리보기" style="max-height: 300px;">
            </div>

            <button class="modal-btn" onclick="viewDownloadedFile()">
                📄 다운로드한 파일 열기
            </button>
            <button class="modal-btn secondary" onclick="closeDownloadModal()">
                닫기
            </button>
        </div>
    </div>

    <div class="container" id="formContainer">
        <!-- Page 1: 기본 정보 -->
        <div class="card active" id="page1">
            <div class="progress-bar">
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
            </div>
            
            <div class="card-header">
                <div class="card-number">1 / 3</div>
                <h1 class="main-title">✨신청서 작성</h1>
                <p class="card-subtitle">회원님의 정보를 입력해주세요</p>
                <div class="divider">━━━━━━━━━━━━━━━━━━━</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">회원 성명 *</label>
                <input type="text" class="form-input" id="name" required placeholder="이름을 입력하세요" autofocus>
            </div>
            
            <div class="form-group">
                <label class="form-label">동 / 호수 *</label>
                <div class="select-group">
                    <input type="number" inputmode="numeric" class="form-input" id="dong" placeholder="동" maxlength="3" style="flex: 1;">
                    <input type="number" inputmode="numeric" class="form-input" id="ho" placeholder="호수" style="flex: 1;">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">연락처 *</label>
                <div class="select-group">
                    <input type="text" class="form-input" value="010" readonly style="flex: 0.8;">
                    <input type="number" inputmode="numeric" class="form-input" id="phone1" placeholder="1234" maxlength="4" style="flex: 1;">
                    <input type="number" inputmode="numeric" class="form-input" id="phone2" placeholder="1234" maxlength="4" style="flex: 1;">
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-next" onclick="nextPage(1)">다음</button>
            </div>
        </div>
        
        <!-- Page 2: 프로그램 선택 -->
        <div class="card" id="page2">
            <div class="progress-bar">
                <div class="progress-dot"></div>
                <div class="progress-dot active"></div>
                <div class="progress-dot"></div>
            </div>
            
            <div class="card-header">
                <div class="card-number">2 / 3</div>
                <h2 class="card-title">프로그램 선택</h2>
                <p class="card-subtitle">등록하실 프로그램을 선택해주세요</p>
            </div>
            
            <div class="form-group" id="programSelectionGroup">
                <label class="form-label">리:얼 프로그램 *</label>
                <div class="program-grid">                    
                    <div class="program-option">
                        <input type="radio" name="program" id="stretching" value="리:얼 P-스트레칭">
                        <label for="stretching">
                            <div class="program-name text-[#5185D4]">P-스트레칭</div>
                            <div class="program-desc">전문가와 함께, 맞춤 스트레칭</div>
                        </label>
                    </div>
                    <div class="program-option">
                        <input type="radio" name="program" id="facecare" value="리:얼 작은얼굴">
                        <label for="facecare">
                            <div class="program-name text-[#EA580C]">작은얼굴</div>
                            <div class="program-desc">얼굴 라인 관리 및 페이셜 케어</div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">시작 주차 선택 *</label>
                <select class="form-input" id="startWeek" onchange="calculateAmount()">
                    <option value="">시작 주차를 선택하세요</option>
                </select>
                <div id="weekInfo" style="margin-top: 8px; font-size: 13px; color: #666;"></div>
            </div>

            <div class="form-group">
                <label class="form-label">수업 요일 * (복수 선택 가능)</label>
                <div class="weekday-grid">
                    <div class="weekday-option">
                        <input type="checkbox" name="weekday" id="mon" value="월">
                        <label for="mon">월</label>
                    </div>
                    <div class="weekday-option">
                        <input type="checkbox" name="weekday" id="tue" value="화">
                        <label for="tue">화</label>
                    </div>
                    <div class="weekday-option">
                        <input type="checkbox" name="weekday" id="wed" value="수">
                        <label for="wed">수</label>
                    </div>
                    <div class="weekday-option">
                        <input type="checkbox" name="weekday" id="thu" value="목">
                        <label for="thu">목</label>
                    </div>
                    <div class="weekday-option">
                        <input type="checkbox" name="weekday" id="fri" value="금">
                        <label for="fri">금</label>
                    </div>
                    <div class="weekday-option">
                        <input type="checkbox" name="weekday" id="sat" value="토">
                        <label for="sat">토</label>
                    </div>
                    <div class="weekday-option">
                        <input type="checkbox" name="weekday" id="sun" value="일">
                        <label for="sun">일</label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">수업 시간 *</label>
                <div class="select-group">
                    <select class="form-input" id="timeHour">
                        <option value="">시간</option>
                        <option value="09">오전 9시</option>
                        <option value="10">오전 10시</option>
                        <option value="11">오전 11시</option>
                        <option value="12">오후 12시</option>
                        <option value="14">오후 2시</option>
                        <option value="15">오후 3시</option>
                        <option value="16">오후 4시</option>
                        <option value="17">오후 5시</option>
                        <option value="19">오후 7시</option>
                        <option value="20">오후 8시</option>
                    </select>
                    <select class="form-input" id="timeMinute">
                        <option value="">분</option>
                        <option value="00" selected>00분</option>
                        <option value="30">30분</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" id="amountGroup" style="display: none;">
                <label class="form-label">결제 금액 선택 *</label>
                
                <div class="program-option" id="single1Option" style="display: none;">
                    <input type="radio" name="packageType" id="single1" value="single1" onchange="updateAmountDisplay()">
                    <label for="single1">
                        <div class="program-name">1회 이용권</div>
                        <div class="program-desc" id="single1Desc">45,000원 (1회)</div>
                    </label>
                </div>
                
                <div class="program-option" id="weekly1Option" style="display: none;">
                    <input type="radio" name="packageType" id="weekly1" value="weekly1" onchange="updateAmountDisplay()">
                    <label for="weekly1">
                        <div class="program-name">주 1회 패키지</div>
                        <div class="program-desc" id="weekly1Desc">170,000원 (4회, 회당 42,500원)</div>
                    </label>
                </div>
                
                <div class="program-option" id="weekly2Option" style="display: none;">
                    <input type="radio" name="packageType" id="weekly2" value="weekly2" onchange="updateAmountDisplay()">
                    <label for="weekly2">
                        <div class="program-name">주 2회 패키지 <span style="color: #4CAF50; font-weight: bold;">추천!</span></div>
                        <div class="program-desc" id="weekly2Desc">320,000원 (8회, 회당 40,000원)</div>
                    </label>
                </div>
                
                <div class="program-option" id="familyOption" style="display: none;">
                    <input type="radio" name="packageType" id="family" value="family" onchange="updateAmountDisplay()">
                    <label for="family">
                        <div class="program-name">패밀리 패키지 <span style="color: #FF5722; font-weight: bold;">가족 공유 가능!</span></div>
                        <div class="program-desc" id="familyDesc">450,000원 (12회, 회당 37,500원)</div>
                    </label>
                </div>
                
                <div class="program-option">
                    <input type="radio" name="packageType" id="customAmount" value="custom" onchange="updateAmountDisplay()">
                    <label for="customAmount">
                        <div class="program-name">직접 입력</div>
                        <div class="program-desc">특별한 사유로 금액을 직접 입력합니다</div>
                    </label>
                </div>
                
                <div id="customAmountInput" style="display: none; margin-top: 10px;">
                    <input type="text" class="form-input" id="customAmountValue" placeholder="금액을 입력하세요 (원)" oninput="formatCurrency(this)">
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-prev" onclick="prevPage(2)">이전</button>
                <button class="btn btn-next" onclick="nextPage(2)">다음</button>
            </div>
        </div>
        
        <!-- Page 3: 약관 동의 및 서명 -->
        <div class="card" id="page3">
            <div class="progress-bar">
                <div class="progress-dot"></div>
                <div class="progress-dot"></div>
                <div class="progress-dot active"></div>
            </div>
            
            <div class="card-header">
                <div class="card-number">3 / 3</div>
                <h2 class="card-title">약관 동의</h2>
                <p class="card-subtitle">이용약관을 확인하고 동의해주세요</p>
            </div>
            
            <div class="terms-box" id="termsBox">
                <h4>[ 이용약관 ]</h4>
                <ol>
                    <li>본인 부주의로 발생되는 사고에 대해서는 책임을 지지 않습니다.</li>
                    <li>해지를 원하시는 입주민은 <strong>반드시 안내 데스크에 방문하셔서 <span style="color: red;">해지신청서</span> 작성.</strong></li>                    
                    <li>등록 후 <strong>미 이용 시 연기 및 환불이 불가하며 반드시 해지신청</strong>하셔야 합니다.</li>
                    <li>안전을 위해 영유아, 초등학생, 애완동물의 동반출입을 금지합니다.</li>                    
                    <li>음주 후 출입불가 하며, 모든 음식물 반입을 금지합니다.</li>
                    <li>모든 비품과 시설물의 보호에 힘쓰고, 고의/과실로 파손하거나 훼손한 경우 배상 책임이 있습니다.</li>
                </ol>
            </div>
            
            <div class="checkbox-group">
                <div class="checkbox-option" id="agreeOption1">
                    <input type="checkbox" id="agree1" onchange="handleAgree1Change()">
                    <label for="agree1">이용약관에 동의합니다</label>
                </div>
            </div>
            
            <div class="privacy-box" id="privacyBox">
                <h4>[ 개인정보 수집·이용 동의서 ]</h4>
                <p><strong>1. 개인정보 수집·이용 목적</strong></p>
                <p>- 커뮤니티센터 운영에 대한 이용약관 동의 및 회원가입 신청</p>
                
                <p><strong>2. 수집항목</strong></p>
                <p>- 성명, 성별, 생년월일, 주소, 전화번호</p>
                
                <p><strong>3. 보유·이용기간</strong></p>
                <p>- 이용종료 후 2년</p>
                
                <p><strong>4. 동의 거부 고지</strong></p>
                <p>- 개인정보 수집, 이용을 거부하실 수 있습니다. 거부할 경우 커뮤니티시설 이용이 제한될 수 있습니다.</p>
                
                <p><strong>5. 제3자 제공 동의</strong></p>
                <p>- 제공받는 자: (주)스포이즘, 관리사무소</p>
                <p>- 이용목적: 커뮤니티시설 이용의 확인 및 입주민 확인</p>
                <p>- 제공항목: 성명, 전화번호, 생년월일, 주소</p>
                <p>- 보유기간: 커뮤니티 이용 종료 후 2년</p>
            </div>
            
            <div class="checkbox-group" id="agree2Group" style="display: none;">
                <div class="checkbox-option" id="agreeOption2">
                    <input type="checkbox" id="agree2" onchange="handleAgree2Change()">
                    <label for="agree2">개인정보 수집·이용에 동의합니다</label>
                </div>
            </div>
            
            <div class="form-group" id="signatureGroup" style="display: none;">
                <label class="form-label">서명 *</label>
                <p class="signature-help">✍️ 아래 박스에 손가락이나 마우스로 서명해주세요</p>
                <div class="signature-pad">
                    <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                </div>
                <button class="signature-clear" onclick="clearSignature()">서명 지우기</button>
            </div>
            
            <div class="button-group" id="buttonGroup">
                <button class="btn btn-prev" onclick="prevPage(3)">이전</button>
                <button class="btn btn-next" onclick="submitForm()">다음</button>
            </div>
        </div>
    </div>

    <!-- Final Page (반응형) -->
    <div class="final-page" id="finalPage" style="display: none;">
        <div class="success-box">
            <h2>✅ 신청서 작성 완료!</h2>
            <p>아래 내용을 확인하시고 결제를 완료해주세요</p>
        </div>

        <!-- 반응형 미리보기 -->
        <div class="document-preview">
            <h1 class="document-title">G·X) 커뮤니티센터 회원 신청서</h1>
            
            <table class="info-table">
                <tr>
                    <td class="label">회원성명</td>
                    <td colspan="3" id="previewName"></td>
                    <td class="label">신청일자</td>
                    <td id="previewDate"></td>
                </tr>
                <tr>
                    <td class="label">동 / 호수</td>
                    <td colspan="2" id="previewAddress"></td>                    
                    <td class="label">연락처</td>
                    <td colspan="5" id="previewPhone"></td>
                </tr>
                <tr>
                    <td class="label">결제금액</td>
                    <td colspan="5" id="previewAmount"></td>
                </tr>
            </table>
            
            <div class="application-section">
                <div class="section-title">등록 프로그램</div>
                <div style="padding: 15px;">
                    <div id="previewProgram" style="color: red; font-weight: bold; margin-bottom: 8px; font-size: 13px;"></div>
                    <div id="previewSchedule" style="color: red; font-weight: bold; margin-bottom: 8px; font-size: 14px;"></div>
                    <div id="previewStartDate" style="color: red; font-weight: bold; font-size: 15px;"></div>
                </div>
            </div>
        </div>
        
        <button class="drive-btn" onclick="uploadToDrive()">
            💳 결제 완료 & 신청서 다운로드
        </button>
        <p style="text-align: center; font-size: 12px; color: #666; margin-top: 10px;">
            해당 결제는 아파트 관리비로 청구됩니다.
        </p>
    </div>

    <!-- A4 캡처용 숨김 문서 -->
    <div id="captureArea" class="a4-document">
        <h1 class="document-title">G·X) 커뮤니티센터 회원 신청서</h1>
        
        <table class="info-table">
            <tr>
                <td class="label">회원성명</td>
                <td colspan="3" id="finalName"></td>
                <td class="label">신청일자</td>
                <td id="finalDate"></td>
            </tr>
            <tr>                
                <td class="label">동 / 호수</td>
                <td colspan="2" id="finalAddress"></td>                                
                <td class="label">연락처</td>
                <td colspan="5" id="finalPhone"></td>                
            </tr>
            <tr>
                <td class="label">결제금액</td>                
                <td colspan="5" id="finalAmount" style="color: red;"></td>
            </tr>
        </table>
        
        <table class="info-table" style="margin-bottom: 8px;">
            <tr>
                <td class="label" rowspan="2" style="vertical-align: middle; width: 80px;">등록<br>프로그램</td>                
                <td id="finalProgram" style="color: red; font-size: 10px;"></td>
            </tr>
            <tr>                                
                <td style="color: red; font-size: 10px;">
                    <span id="finalSchedule"></span>
                    <span id="finalStartDate" style="color: red; font-weight: bold; margin-left: 10px;"></span>
                    <span id="previewStartDate" style="color: red; font-weight: bold; font-size: 15px;"></span>
                </td>
            </tr>
        </table>
        
        <div class="agreement-title">[ 이용약관 및 개인정보동의서 ]</div>
        
        <ol class="agreement-list">
            <li>본인 부주의로 발생되는 사고에 대해서는 책임을 지지 않습니다.</li>
            <li>커뮤니티 시설 이용 신청은 수시접수이며 수업인원에 따라 일할 계산됩니다.</li>
            <li>해지를 원하시는 입주민은 <strong>반드시 안내 데스크에 방문하셔서 <span style="color: red;">해지신청서</span> 작성.</strong><br>
            ※ 해지 신청을 하지 않아 발생된 요금의 책임은 본인에게 있습니다.</li>
            <li>등록 후 <strong>미 이용 시 연기 및 환불이 불가하며 반드시 해지신청</strong>하셔야 합니다. (양도 가능)</li>            
        </ol>
        
        <div class="note-box">
            3장 및 4장 내용 확인 [서명 : <span class="signature-in-note" id="noteSignature"></span>]
        </div>
        
        <ol class="agreement-list" start="5">                        
            <li>모든 비품과 시설물의 보호에 힘쓰고, 고의/과실로 파손하거나 훼손한 경우 배상 책임이 있습니다.</li>            
            <li>이외의 모든 운영규칙을 읽어보고 확인하였습니다.</li>            
        </ol>
        
        <div class="detailed-agreement">
            <h3>1. 개인정보동의서</h3>
            <p>1) 수집, 이용 목적 : 힐스테이트자이계양 아파트 커뮤니티센터 운영에 대한 이용약관 동의 및 회원가입 신청</p>
            <p>2) 보유기간·수집항목 : 이용종료 후 2년으로, 성명, 성별, 생년월일, 주소, 전화번호 가 해당</p>            
                        
            <h3>2. 제3자 제공 동의</h3>
            <p>1) 제공받는 자 : (주)스포이즘, 관리사무소</p>
            <p>2) 제공항목과 이용목적 : 성명, 전화번호, 동/호수, 커뮤니티시설 이용의 확인 및 입주민 확인</p>            
            <p>3) 제공받는 자의 보유 : 커뮤니티 이용 종료 후 2년</p>
            
            <h3>* 동의 거부 고지</h3>
            <p>- 개인정보 수집,이용 및 제3자 제공을 거부하실 수 있습니다. 거부할 경우 시설 이용이 제한될 수 있습니다.</p>
        </div>
        
        <div class="consent-box">
            <h3>개인정보 수집,이용 및 제3자 제공 동의 ☑</h3>
            <p>본인은 위 목적으로 회원가입 신청에 제시된 이용약관을 충분히 이해하였습니다.<br>
            개인정보의 수집 · 이용 · 제공 · 조회에 관하여 동의하며 회원가입을 신청합니다.</p>
        </div>
        
        <div class="signature-section" style="margin-top: 1px;">
            <div class="signature-line">
                <label>신청인</label>
                <div class="signature-display">
                    <img id="finalSignature" src="" alt="서명">
                </div>
                (인)
            </div>            
        </div>
    </div>

    <script>
        // ========================================
        // Google Apps Script 설정
        // ========================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzs2yxbiilKz8KQ0E9uXsU0_RR1iasipKX8ZOD8t13k7kFP6Vpp4QWpPk2sgQusY7oMwg/exec';
        
        // ========================================
        // 기존 변수
        // ========================================
        let currentPage = 1;
        let canvas, ctx;
        let isDrawing = false;
        let capturedBlob = null;
        let downloadedFileUrl = null;
        
        // ========================================
        // 페이지 로드 시 시작 주차 옵션 생성
        // ========================================
        window.addEventListener('DOMContentLoaded', function() {
            generateStartWeekOptions();
            
            // 요일 체크박스에 이벤트 리스너 추가
            const weekdayCheckboxes = document.querySelectorAll('input[name="weekday"]');
            weekdayCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updatePaymentOptions);
            });
            
            // 프로그램 선택 시 스크롤
            const programRadios = document.querySelectorAll('input[name="program"]');
            programRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    setTimeout(() => {
                        window.scrollTo({
                            top: document.body.scrollHeight,
                            behavior: 'smooth'
                        });
                    }, 100);
                });
            });
            
            // 수업 시간(분) 선택 시 스크롤
            const timeMinuteSelect = document.getElementById('timeMinute');
            if (timeMinuteSelect) {
                timeMinuteSelect.addEventListener('change', function() {
                    setTimeout(() => {
                        window.scrollTo({
                            top: document.body.scrollHeight,
                            behavior: 'smooth'
                        });
                    }, 100);
                });
            }
        });
        
        function updatePaymentOptions() {
            const selectedWeekdays = document.querySelectorAll('input[name="weekday"]:checked');
            const weekdayCount = selectedWeekdays.length;
            
            const single1Option = document.getElementById('single1Option');
            const weekly1Option = document.getElementById('weekly1Option');
            const weekly2Option = document.getElementById('weekly2Option');
            const familyOption = document.getElementById('familyOption');
            
            // 모든 옵션 초기화
            single1Option.style.display = 'none';
            weekly1Option.style.display = 'none';
            weekly2Option.style.display = 'none';
            familyOption.style.display = 'none';
            
            // 선택 해제
            document.getElementById('single1').checked = false;
            document.getElementById('weekly1').checked = false;
            document.getElementById('weekly2').checked = false;
            document.getElementById('family').checked = false;
            
            if (weekdayCount === 1) {
                // 1개 선택: 1회권 + 주 1회
                single1Option.style.display = 'block';
                weekly1Option.style.display = 'block';
            } else if (weekdayCount === 2) {
                // 2개 선택: 주 2회만
                weekly2Option.style.display = 'block';
            } else if (weekdayCount >= 3) {
                // 3개 이상 선택: 가족 공유
                familyOption.style.display = 'block';
            }
            
            // 금액 재계산
            if (document.getElementById('startWeek').value) {
                calculateAmount();
            }
        }
        
        function generateStartWeekOptions() {
            const select = document.getElementById('startWeek');
            if (!select) return;
            
            select.innerHTML = '<option value="">선택하세요</option>';
            
            const today = new Date();
            const currentMonday = getCurrentWeekMonday(today);
            
            // 핵심 날짜 설정 (2026년 기준)
            const jan1stMon = new Date(2026, 0, 5);  // 1월 1주차 월요일
            const jan1stSun = new Date(2026, 0, 11, 23, 59, 59); // 1월 1주차 일요일 종료
            const feb1stMon = new Date(2026, 1, 2);  // 2월 1주차 월요일
            const mar1stMon = new Date(2026, 2, 2);  // 3월 1주차 월요일

            let startDate, endDate, defaultDate;

            // 1) 1월 1주차가 지나지 않은 경우 (오늘 <= 1월 11일)
            if (today <= jan1stSun) {
                startDate = jan1stMon;      // 1월 1주차부터 표시
                endDate = feb1stMon;        // 다음 달(2월) 1주차까지 표시
                defaultDate = jan1stMon;    // 기본 선택: 1월 1주차
            } 
            // 2) 1월 1주차가 지난 경우
            else {
                startDate = currentMonday;  // 현재 주차부터 표시 (이미 지난 주는 자동 제외)
                endDate = mar1stMon;        // 3월 1주차까지 표시 범위 확장
                defaultDate = feb1stMon;    // 기본 선택: 2월 1주차
            }

            // 옵션 생성 루프
            let tempDate = new Date(startDate);
            while (tempDate <= endDate) {
                addWeekOption(select, tempDate);
                tempDate.setDate(tempDate.getDate() + 7);
            }

            // 기본값 설정
            const defaultValue = formatDateForDB(defaultDate);
            // 생성된 옵션 중에 defaultDate가 있는지 확인 후 선택
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].value === defaultValue) {
                    select.selectedIndex = i;
                    break;
                }
            }
            
            // 만약 해당 날짜가 목록에 없다면(예: 2월 1주차도 지남) 마지막 옵션 선택
            if (select.selectedIndex <= 0 && select.options.length > 1) {
                select.selectedIndex = select.options.length - 1;
            }

            if (typeof calculateAmount === 'function') calculateAmount();
        }
        
        // 현재 주의 월요일 구하기
        function getCurrentWeekMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = day === 0 ? -6 : 1 - day; // 일요일이면 -6, 아니면 월요일까지
            d.setDate(d.getDate() + diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }
        
        // 이번 달 남은 주차들 구하기 (다음 주차부터 표시)
        function getRemainingWeeksInMonth(startMonday) {
            const weeks = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentMonth = startMonday.getMonth();
            let monday = new Date(startMonday);
            
            // 같은 달 안의 모든 월요일 찾기
            while (monday.getMonth() === currentMonth) {
                // 다음 주차부터만 추가 (현재 주 제외)
                if (monday > today) {
                    weeks.push(new Date(monday));
                }
                monday.setDate(monday.getDate() + 7);
            }
            
            return weeks;
        }
        
        // 다음 달 첫 월요일 구하기
        function getNextMonthFirstMonday(currentMonday) {
            const today = new Date();
            console.log('=== getNextMonthFirstMonday DEBUG ===');
            console.log('오늘:', today.toISOString());
            console.log('오늘 연도:', today.getFullYear());
            console.log('오늘 월:', today.getMonth() + 1);
            
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // 다음 달 1일 구하기
            let nextMonth, nextYear;
            if (currentMonth === 11) {  // 12월이면
                nextMonth = 0;  // 1월
                nextYear = currentYear + 1;
            } else {
                nextMonth = currentMonth + 1;
                nextYear = currentYear;
            }
            
            console.log('다음 달:', nextYear + '년', (nextMonth + 1) + '월');
            
            const firstDay = new Date(nextYear, nextMonth, 1);
            console.log('다음 달 1일:', firstDay.toISOString());
            
            // 1일이 무슨 요일인지 확인
            const day = firstDay.getDay();
            
            // 1일이 속한 주의 월요일 찾기
            let diff;
            if (day === 0) {  // 일요일 - 전날(토요일) 포함한 주의 월요일은 이전 달
                diff = -6;  // 6일 전 월요일
            } else if (day === 1) {  // 월요일
                diff = 0;
            } else {  // 화~토 - 이전 월요일
                diff = -(day - 1);
            }
            
            const monday = new Date(firstDay);
            monday.setDate(1 + diff);
            
            console.log('1일이 속한 주 월요일:', monday.toISOString());
            
            // 월요일이 다음 달에 속하면 그대로, 이전 달이면 다음 월요일(다음 달 내)
            if (monday.getMonth() !== nextMonth) {
                console.log('→ 이전 달이므로 +7일');
                monday.setDate(monday.getDate() + 7);
            }
            
            console.log('최종 월요일:', monday.toISOString());
            console.log('formatDateForDB:', formatDateForDB(monday));
            console.log('=== DEBUG 끝 ===');
            
            return monday;
        }
        
        // 옵션 추가
        function addWeekOption(select, monday) {
            const month = monday.getMonth() + 1;
            const weekOfMonth = getWeekOfMonth(monday);
            const dateStr = formatDate(monday);
            const displayStr = `${month}월 ${weekOfMonth}주차 (${dateStr}일 이후)`;
            
            const option = document.createElement('option');
            option.value = formatDateForDB(monday);
            option.textContent = displayStr;
            option.dataset.weeks = calculateRemainingWeeks(monday);
            
            select.appendChild(option);           
            
        }
        
        function getWeekOfMonth(date) {
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
            const dayOfMonth = date.getDate();
            const weekNumber = Math.ceil((dayOfMonth + firstDay.getDay()) / 7);
            return weekNumber;
        }
        
        function formatDate(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }
        
        function formatDateForDB(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function calculateRemainingWeeks(startDate) {
            const endOfMonth = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
            const diffTime = endOfMonth - startDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const weeks = Math.min(5, Math.ceil(diffDays / 7));
            return weeks;
        }
        
        function calculateAmount() {
            const select = document.getElementById('startWeek');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                document.getElementById('amountGroup').style.display = 'none';
                return;
            }
            
            const weeks = parseInt(selectedOption.dataset.weeks);
            const weekInfo = document.getElementById('weekInfo');
            weekInfo.textContent = `${weeks}주 패키지 (${weeks === 4 ? '한 달 전체' : `이번 달 남은 ${weeks}주`})`;
            
            const selectedWeekdays = document.querySelectorAll('input[name="weekday"]:checked');
            const weekdayCount = selectedWeekdays.length;
            
            // 시작 날짜 계산
            const startDateStr = selectedOption.value; // "2025-12-09"
            const startDate = new Date(startDateStr);
            const firstSessionDates = getFirstSessionDates(startDate, selectedWeekdays);
            
            // 금액 계산
            const single1Amount = 45000;
            const weekly1Amount = weeks * 42500;
            const weekly2Amount = weeks * 40000 * 2;
            const familyAmount = weeks * 37500 * weekdayCount;
            
            // 날짜 정보 포함한 설명 (줄바꿈 후 표시)
            const dateInfo = firstSessionDates.length > 0 ? 
                `<br><strong style="color: #079992; font-weight: 700; font-size: 1.3em;">첫 시작: ${firstSessionDates.join(', ')}</strong>` : '';
            
            document.getElementById('single1Desc').innerHTML = 
                `${single1Amount.toLocaleString()}원 (1회)${dateInfo}`;
            document.getElementById('weekly1Desc').innerHTML = 
                `${weekly1Amount.toLocaleString()}원 (${weeks}회, 회당 42,500원)${dateInfo}`;
            document.getElementById('weekly2Desc').innerHTML = 
                `${weekly2Amount.toLocaleString()}원 (${weeks * 2}회, 회당 40,000원)${dateInfo}`;
            document.getElementById('familyDesc').innerHTML = 
                `${familyAmount.toLocaleString()}원 (${weeks * weekdayCount}회, 회당 37,500원)${dateInfo}`;
            
            // 금액 선택 영역 표시
            document.getElementById('amountGroup').style.display = 'block';
        }
        
        function getFirstSessionDates(startDate, selectedWeekdays) {
            if (selectedWeekdays.length === 0) return [];
            
            const dayMap = {
                '월': 1, '화': 2, '수': 3, '목': 4, '금': 5, '토': 6, '일': 0
            };
            
            const weekdayNames = ['일', '월', '화', '수', '목', '금', '토'];
            const dates = [];
            
            Array.from(selectedWeekdays).forEach(checkbox => {
                const weekdayKor = checkbox.value;
                const targetDay = dayMap[weekdayKor];
                const currentDay = startDate.getDay();
                
                // 시작 날짜부터 해당 요일까지의 차이 계산
                let daysToAdd = targetDay - currentDay;
                if (daysToAdd < 0) daysToAdd += 7;
                
                const sessionDate = new Date(startDate);
                sessionDate.setDate(startDate.getDate() + daysToAdd);
                
                dates.push({
                    date: sessionDate,
                    month: sessionDate.getMonth() + 1,
                    day: sessionDate.getDate(),
                    dayName: weekdayNames[sessionDate.getDay()]
                });
            });
            
            // 날짜순 정렬
            dates.sort((a, b) => a.date - b.date);
            
            // 가장 빠른 날짜만 반환
            if (dates.length > 0) {
                const firstDate = dates[0];
                return [`${firstDate.month}/${firstDate.day}(${firstDate.dayName})`];
            }
            
            return [];
        }
        
        function updateAmountDisplay() {
            const customAmountRadio = document.getElementById('customAmount');
            const customAmountInput = document.getElementById('customAmountInput');
            
            if (customAmountRadio.checked) {
                customAmountInput.style.display = 'block';
            } else {
                customAmountInput.style.display = 'none';
            }
        }
        
        function formatCurrency(input) {
            // 숫자만 추출
            let value = input.value.replace(/[^0-9]/g, '');
            
            // 3자리마다 쉼표 추가
            if (value) {
                value = parseInt(value).toLocaleString('ko-KR');
            }
            
            input.value = value;
        }
        
        // 동 입력 - 3자리 입력 시 호수로 이동
        document.getElementById('dong').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length >= 3) {
                value = value.slice(0, 3);
                e.target.value = value;
                document.getElementById('ho').focus();
            } else {
                e.target.value = value;
            }
        });
        
        // 호 입력 - 4자리 입력 시 호수로 이동
        document.getElementById('ho').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length >= 4) {
                value = value.slice(0, 4);
                e.target.value = value;
                document.getElementById('phone1').focus();
            } else {
                e.target.value = value;
            }
        });

        // 연락처 중간 4자리 자동 이동
        document.getElementById('phone1').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length >= 4) {
                value = value.slice(0, 4);
                e.target.value = value;
                document.getElementById('phone2').focus();
            } else {
                e.target.value = value;
            }
        });
        
        // 연락처 끝 4자리 입력 후 결제 금액 선택 보이기
        document.getElementById('phone2').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            if (value.length >= 4) {
                value = value.slice(0, 4);
                e.target.value = value;
            } else {
                e.target.value = value;
            }
        });

        
        // 약관 동의 1 처리 - 제출하기 버튼이 보이도록 스크롤
        function handleAgree1Change() {
            const agree1 = document.getElementById('agree1').checked;
            const termsBox = document.getElementById('termsBox');
            const privacyBox = document.getElementById('privacyBox');
            const agree2Group = document.getElementById('agree2Group');
            const agreeOption1 = document.getElementById('agreeOption1');
            
            if (agree1) {
                termsBox.classList.add('collapsed');
                privacyBox.classList.add('expanded');
                agree2Group.style.display = 'block';
                agreeOption1.classList.add('checked');
                
                setTimeout(() => {
                    // window.scrollTo(x, y)를 사용하여 스크롤 위치를 설정합니다.
                    // x: 가로 스크롤 (0으로 설정)
                    // y: 문서의 전체 높이 (document.body.scrollHeight)
                    window.scrollTo({
                        top: document.body.scrollHeight, // 문서의 전체 높이
                        behavior: 'smooth'            // 부드러운 스크롤 유지
                    });
                }, 600);
            } else {
                termsBox.classList.remove('collapsed');
                privacyBox.classList.remove('expanded');
                privacyBox.classList.remove('collapsed');
                agree2Group.style.display = 'none';
                document.getElementById('agree2').checked = false;
                document.getElementById('signatureGroup').style.display = 'none';
                agreeOption1.classList.remove('checked');
            }
        }
        
        // 약관 동의 2 처리 - 스크롤 하지 않음
        function handleAgree2Change() {
            const agree2 = document.getElementById('agree2').checked;
            const privacyBox = document.getElementById('privacyBox');
            const signatureGroup = document.getElementById('signatureGroup');
            const agreeOption2 = document.getElementById('agreeOption2');
            
            if (agree2) {
                privacyBox.classList.remove('expanded');
                privacyBox.classList.add('collapsed');
                signatureGroup.style.display = 'block';
                agreeOption2.classList.add('checked');
                setTimeout(initCanvas, 100);
            } else {
                privacyBox.classList.add('expanded');
                privacyBox.classList.remove('collapsed');
                signatureGroup.style.display = 'none';
                agreeOption2.classList.remove('checked');
            }
        }
        
        function initCanvas() {
            canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            // 고해상도 디스플레이 대응
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            ctx.scale(dpr, dpr);
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, rect.width, rect.height);
            
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            const newCanvas = canvas.cloneNode(true);
            canvas.parentNode.replaceChild(newCanvas, canvas);
            canvas = newCanvas;
            ctx = canvas.getContext('2d');
            
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            ctx.scale(dpr, dpr);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, rect.width, rect.height);
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchcancel', stopDrawing);
        }
        
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }
        
        function getTouchPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: e.touches[0].clientX - rect.left,
                y: e.touches[0].clientY - rect.top
            };
        }
        
        function startDrawing(e) {
            isDrawing = true;
            const pos = getMousePos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            isDrawing = true;
            const pos = getTouchPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            const pos = getMousePos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const pos = getTouchPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }
        
        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }
        
        function clearSignature() {
            const rect = canvas.getBoundingClientRect();
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, rect.width, rect.height);
            ctx.fillStyle = '#000000';
        }
        
        function nextPage(page) {
            if (page === 1) {
                const name = document.getElementById('name').value;
                const dong = document.getElementById('dong').value;
                const ho = document.getElementById('ho').value;
                const phone1 = document.getElementById('phone1').value;
                const phone2 = document.getElementById('phone2').value;
                
                if (!name || !dong || !ho || !phone1 || !phone2) {
                    alert('모든 항목을 입력해주세요.');
                    return;
                }
                
                if (phone1.length !== 4 || phone2.length !== 4) {
                    alert('연락처를 정확히 입력해주세요.');
                    return;
                }
            }
            
            if (page === 2) {
                const program = document.querySelector('input[name="program"]:checked');
                const weekdays = document.querySelectorAll('input[name="weekday"]:checked');
                const timeHour = document.getElementById('timeHour').value;
                const timeMinute = document.getElementById('timeMinute').value;
                const startWeek = document.getElementById('startWeek').value;
                const packageType = document.querySelector('input[name="packageType"]:checked');
                
                if (!program) {
                    alert('프로그램을 선택해주세요.');
                    return;
                }
                
                if (weekdays.length === 0) {
                    alert('수업 요일을 선택해주세요.');
                    return;
                }
                
                if (!timeHour || !timeMinute) {
                    alert('수업 시간을 선택해주세요.');
                    return;
                }
                
                if (!startWeek) {
                    alert('시작 주차를 선택해주세요.');
                    return;
                }
                
                if (!packageType) {
                    alert('결제 금액을 선택해주세요.');
                    return;
                }
                
                // 직접 입력 선택 시 금액 확인
                if (packageType && packageType.value === 'custom') {
                    const customAmountValue = document.getElementById('customAmountValue').value.replace(/,/g, '');
                    if (!customAmountValue || parseInt(customAmountValue) <= 0) {
                        alert('결제 금액을 입력해주세요.');
                        return;
                    }
                }
            }
            
            document.getElementById(`page${page}`).classList.remove('active');
            document.getElementById(`page${page + 1}`).classList.add('active');
            currentPage = page + 1;
            
            window.scrollTo(0, 0);
        }
        
        function prevPage(page) {
            document.getElementById(`page${page}`).classList.remove('active');
            document.getElementById(`page${page - 1}`).classList.add('active');
            currentPage = page - 1;
            
            window.scrollTo(0, 0);
        }
        
        function submitForm() {
            const agree1 = document.getElementById('agree1').checked;
            const agree2 = document.getElementById('agree2').checked;
            
            if (!agree1 || !agree2) {
                alert('모든 약관에 동의해주세요.');
                return;
            }
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let hasSignature = false;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                if (r < 250 || g < 250 || b < 250) {
                    hasSignature = true;
                    break;
                }
            }
            
            if (!hasSignature) {
                alert('서명을 해주세요.');
                return;
            }
            
            generateFinalPage();
        }
        
        async function generateFinalPage() {
            document.getElementById('loadingOverlay').classList.add('active');
            document.getElementById('loadingText').textContent = '신청서를 생성하는 중...';
            
            // 뷰포트 메타태그 임시 저장 및 변경
            const viewport = document.querySelector('meta[name="viewport"]');
            const originalContent = viewport.content;
            viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=5.0';
            
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            
            const weekdays = Array.from(document.querySelectorAll('input[name="weekday"]:checked'))
                .map(checkbox => checkbox.value);
            const weekdayStr = weekdays.join(', ');
            
            // 결제 금액 가져오기 (새로운 방식)
            const packageTypeRadio = document.querySelector('input[name="packageType"]:checked');
            const selectedWeekdays = document.querySelectorAll('input[name="weekday"]:checked');
            const weekdayCount = selectedWeekdays.length;
            let amountValue = 0;
            
            if (packageTypeRadio) {
                if (packageTypeRadio.value === 'single1') {
                    amountValue = 45000;
                } else if (packageTypeRadio.value === 'custom') {
                    // 쉼표 제거 후 숫자로 변환
                    const customValue = document.getElementById('customAmountValue').value.replace(/,/g, '');
                    amountValue = parseInt(customValue) || 0;
                } else {
                    const startWeekSelect = document.getElementById('startWeek');
                    const weeks = parseInt(startWeekSelect.options[startWeekSelect.selectedIndex].dataset.weeks);
                    
                    if (packageTypeRadio.value === 'weekly1') {
                        amountValue = weeks * 42500;
                    } else if (packageTypeRadio.value === 'weekly2') {
                        amountValue = weeks * 40000 * 2;
                    } else if (packageTypeRadio.value === 'family') {
                        amountValue = weeks * 37500 * weekdayCount;
                    }
                }
            }
            
            const formattedAmount = parseInt(amountValue).toLocaleString('ko-KR');
            
            const nameValue = document.getElementById('name').value;
            const dateValue = `${year}.${month}.${day}`;
            const addressValue = `${document.getElementById('dong').value}동 ${document.getElementById('ho').value}호`;
            const phoneValue = `010 - ${document.getElementById('phone1').value} - ${document.getElementById('phone2').value}`;
            const amountText = `${formattedAmount}원`;
            const programValue = document.querySelector('input[name="program"]:checked').value;
            const timeHour = document.getElementById('timeHour').value;
            const timeMinute = document.getElementById('timeMinute').value;
            const combinedTime = `${timeHour}:${timeMinute}`;
            const scheduleValue = `매주 ${weekdayStr}요일 ${combinedTime}`;
            
            const signatureDataUrl = canvas.toDataURL('image/png');
            
            // 반응형 미리보기 업데이트
            document.getElementById('previewName').textContent = nameValue;
            document.getElementById('previewDate').textContent = dateValue;
            document.getElementById('previewAddress').textContent = addressValue;
            document.getElementById('previewPhone').textContent = phoneValue;
            document.getElementById('previewAmount').textContent = amountText;
            document.getElementById('previewProgram').textContent = programValue;
            document.getElementById('previewSchedule').textContent = scheduleValue;
            
            // A4 캡처용 업데이트
            document.getElementById('finalName').textContent = nameValue;
            document.getElementById('finalDate').textContent = dateValue;
            document.getElementById('finalAddress').textContent = addressValue;
            document.getElementById('finalPhone').textContent = phoneValue;
            document.getElementById('finalAmount').textContent = amountText;
            document.getElementById('finalProgram').textContent = programValue;
            document.getElementById('finalSchedule').textContent = scheduleValue;
            document.getElementById('finalSignature').src = signatureDataUrl;
            
            // 첫 시작 날짜 계산 및 표시
            const startWeekSelect = document.getElementById('startWeek');
            const startDate = new Date(startWeekSelect.value);            
            const firstSessionDates = getFirstSessionDates(startDate, selectedWeekdays);
            
            if (firstSessionDates.length > 0) {
                const dateText = `첫 시작: ${firstSessionDates.join(', ')}`;
                document.getElementById('previewStartDate').textContent = dateText;
                document.getElementById('finalStartDate').textContent = dateText;
            }
            
            document.getElementById('finalSignature').src = signatureDataUrl;

            const noteSignature = document.getElementById('noteSignature');
            const signImg = document.createElement('img');
            signImg.src = signatureDataUrl;
            noteSignature.innerHTML = '';
            noteSignature.appendChild(signImg);
            
            document.getElementById('formContainer').style.display = 'none';
            document.getElementById('finalPage').style.display = 'block';
            
            setTimeout(async () => {
                await captureApplication();
                // 뷰포트 복원
                viewport.content = originalContent;
            }, 500);
        }
        
        async function captureApplication() {
            try {
                const captureArea = document.getElementById('captureArea');
                
                // 캡처 전 임시로 보이게 해서 실제 높이 측정
                captureArea.style.left = '0';
                captureArea.style.position = 'relative';
                
                // 실제 컨텐츠 높이 측정 + 여유 공간 50px 추가
                const actualHeight = captureArea.scrollHeight + 50;
                const actualWidth = 794;
                
                // 다시 숨김
                captureArea.style.left = '-9999px';
                captureArea.style.position = 'absolute';
                
                // 디바이스 픽셀 비율 감지
                const dpr = window.devicePixelRatio || 1;
                
                // 모바일과 데스크탑 모두 동일한 결과를 위한 설정
                const generatedCanvas = await html2canvas(captureArea, {
                    scale: Math.max(2, dpr),
                    width: actualWidth,
                    height: actualHeight,
                    windowWidth: actualWidth,
                    windowHeight: actualHeight,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    scrollY: 0,
                    scrollX: 0,
                    y: 0,
                    x: 0
                });
                
                generatedCanvas.toBlob((blob) => {
                    capturedBlob = blob;
                    document.getElementById('loadingOverlay').classList.remove('active');
                    window.scrollTo(0, 0);
                }, 'image/png', 1.0);
                
            } catch (error) {
                console.error('Error:', error);
                alert('신청서 생성 중 오류가 발생했습니다.');
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }
        
        async function uploadToDrive() {
            // 캡처된 이미지 확인
            if (!capturedBlob) {
                alert('신청서가 생성되지 않았습니다.');
                return;
            }
            
            document.getElementById('loadingOverlay').classList.add('active');
            
            // 7초 카운트다운
            let countdown = 7;
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = `결제를 진행하는 중... ${countdown}초`;
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    loadingText.textContent = `결제를 진행하는 중... ${countdown}초`;
                } else {
                    loadingText.textContent = '결제를 진행하는 중...';
                    clearInterval(countdownInterval);
                }
            }, 1000);

            try {
                const name = document.getElementById('name').value || '신청자';
                const today = new Date();
                const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                const fileName = `커뮤니티센터_회원신청서_${name}_${dateStr}.png`;

                // 신청자 데이터 수집
                const applicantData = collectApplicantData();
                
                console.log('신청자 데이터:', applicantData);
                
                // Blob을 Base64로 변환
                const reader = new FileReader();
                reader.readAsDataURL(capturedBlob);
                
                reader.onloadend = async function() {
                    const base64data = reader.result.split(',')[1];
                    
                    try {
                        // Apps Script로 전송
                        const response = await fetch(APPS_SCRIPT_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'text/plain',
                            },
                            body: JSON.stringify({
                                fileName: fileName,
                                fileData: base64data,
                                applicantData: applicantData
                            })
                        });

                        const result = await response.json();
                        console.log('서버 응답:', result);

                        clearInterval(countdownInterval);
                        document.getElementById('loadingOverlay').classList.remove('active');
                        
                        if (result.success) {
                            // 자동으로 다운로드 시작
                            downloadToDevice();
                            
                            // 성공 모달 표시
                            setTimeout(() => {
                                showSuccessModal(fileName);
                            }, 500);
                        } else {
                            alert('제출 중 오류가 발생했습니다.\n\n' + (result.error || '알 수 없는 오류'));
                        }
                    } catch (fetchError) {
                        console.error('Fetch error:', fetchError);
                        clearInterval(countdownInterval);
                        document.getElementById('loadingOverlay').classList.remove('active');
                        
                        // no-cors fallback - 파일은 업로드되었을 가능성이 높음
                        downloadToDevice();
                        setTimeout(() => {
                            showSuccessModal(fileName);
                        }, 500);
                    }
                };

                reader.onerror = function() {
                    clearInterval(countdownInterval);
                    document.getElementById('loadingOverlay').classList.remove('active');
                    alert('파일 변환 중 오류가 발생했습니다.');
                };

            } catch (error) {
                console.error('Upload error:', error);
                clearInterval(countdownInterval);
                document.getElementById('loadingOverlay').classList.remove('active');
                alert('업로드 중 오류가 발생했습니다.\n\n' + error.message);
            }
        }
        
        function collectApplicantData() {
            // 기본 정보
            const name = document.getElementById('name').value;
            const dong = document.getElementById('dong').value;
            const ho = document.getElementById('ho').value;
            const address = `${dong}동 ${ho}호`;
            const phone1 = document.getElementById('phone1').value;
            const phone2 = document.getElementById('phone2').value;
            const phone = `010-${phone1}-${phone2}`;
            
            // 프로그램 정보
            const programRadio = document.querySelector('input[name="program"]:checked');
            const program = programRadio ? programRadio.value : '';
            
            // 요일 정보 (다중 선택 지원)
            const weekdayCheckboxes = document.querySelectorAll('input[name="weekday"]:checked');
            const weekdays = Array.from(weekdayCheckboxes).map(cb => cb.value);
            const dayOfWeek = weekdays.join(','); // 쉼표로 구분
            
            // 시간 정보
            const timeHour = document.getElementById('timeHour').value;
            const timeMinute = document.getElementById('timeMinute').value;
            const time = `${timeHour}:${timeMinute}`;
            
            // 시작 주차
            const startWeekSelect = document.getElementById('startWeek');
            const startWeekMonday = startWeekSelect.value; // 월요일 날짜
            const weeks = parseInt(startWeekSelect.options[startWeekSelect.selectedIndex].dataset.weeks);
            
            console.log('=== uploadToDrive 시작일/종료일 계산 ===');
            console.log('startWeekMonday (value):', startWeekMonday);
            console.log('weeks:', weeks);
            
            // 선택된 요일들
            const selectedWeekdays = document.querySelectorAll('input[name="weekday"]:checked');
            
            // 실제 시작일 계산 (선택한 요일 중 가장 빠른 날)
            const dayMap = {'월': 1, '화': 2, '수': 3, '목': 4, '금': 5, '토': 6, '일': 0};
            const mondayDate = new Date(startWeekMonday);
            console.log('mondayDate:', mondayDate.toISOString());
            console.log('mondayDate 연도:', mondayDate.getFullYear());
            console.log('mondayDate 월:', mondayDate.getMonth() + 1);
            
            const selectedDays = Array.from(selectedWeekdays).map(cb => dayMap[cb.value]);
            console.log('선택된 요일들 (숫자):', selectedDays);
            
            // 월요일을 기준으로 각 요일까지의 차이 계산 (getFirstSessionDates와 동일한 로직)
            const mondayDay = mondayDate.getDay(); // 월요일 = 1
            const sessionDates = selectedDays.map(targetDay => {
                let daysToAdd = targetDay - mondayDay;
                if (daysToAdd < 0) daysToAdd += 7;
                
                const sessionDate = new Date(mondayDate);
                sessionDate.setDate(mondayDate.getDate() + daysToAdd);
                return {
                    date: sessionDate,
                    daysFromMonday: daysToAdd,
                    targetDay: targetDay
                };
            });
            
            // 날짜순 정렬
            sessionDates.sort((a, b) => a.date - b.date);
            
            console.log('계산된 세션 날짜들:', sessionDates.map(s => ({
                date: s.date.toISOString().split('T')[0],
                daysFromMonday: s.daysFromMonday
            })));
            
            // 시작일 = 가장 빠른 날짜
            const firstSession = sessionDates[0];
            const actualStartDate = firstSession.date;
            
            // 한국식 날짜 포맷 (YYYY.MM.DD)
            const startYear = actualStartDate.getFullYear();
            const startMonth = String(actualStartDate.getMonth() + 1).padStart(2, '0');
            const startDay = String(actualStartDate.getDate()).padStart(2, '0');
            const startDate = `${startYear}.${startMonth}.${startDay}`;
            
            console.log('actualStartDate:', actualStartDate.toISOString());
            console.log('startDate (최종):', startDate);
            
            // 종료일 = 마지막 주의 가장 늦은 날짜
            const lastSession = sessionDates[sessionDates.length - 1];
            const daysToLastSession = lastSession.daysFromMonday + ((weeks - 1) * 7);
            
            console.log('마지막 세션까지 일수:', daysToLastSession);
            
            const actualEndDate = new Date(mondayDate);
            actualEndDate.setDate(mondayDate.getDate() + daysToLastSession);
            
            // 한국식 날짜 포맷 (YYYY.MM.DD)
            const endYear = actualEndDate.getFullYear();
            const endMonth = String(actualEndDate.getMonth() + 1).padStart(2, '0');
            const endDay = String(actualEndDate.getDate()).padStart(2, '0');
            const endDate = `${endYear}.${endMonth}.${endDay}`;
            
            console.log('actualEndDate:', actualEndDate.toISOString());
            console.log('endDate (최종):', endDate);
            console.log('=== 계산 완료 ===');
            
            // 결제 금액 및 주당 횟수
            const packageTypeRadio = document.querySelector('input[name="packageType"]:checked');
            const weekdayCount = selectedWeekdays.length;
            
            let amount = 0;
            let weeklyFrequency = 1;
            let duration = `${weeks}주`;
            
            if (packageTypeRadio) {
                if (packageTypeRadio.value === 'single1') {
                    weeklyFrequency = 1;
                    amount = 45000;
                    duration = '1회';
                } else if (packageTypeRadio.value === 'weekly1') {
                    weeklyFrequency = 1;
                    amount = weeks * 42500;
                } else if (packageTypeRadio.value === 'weekly2') {
                    weeklyFrequency = weekdayCount;
                    amount = weeks * 40000 * 2;
                } else if (packageTypeRadio.value === 'family') {
                    weeklyFrequency = weekdayCount;
                    amount = weeks * 37500 * weekdayCount;
                } else if (packageTypeRadio.value === 'custom') {
                    weeklyFrequency = 1; // 기본값
                    // 쉼표 제거 후 숫자로 변환
                    const customValue = document.getElementById('customAmountValue').value.replace(/,/g, '');
                    amount = parseInt(customValue) || 0;
                }
            }
            
            const totalSessions = packageTypeRadio && packageTypeRadio.value === 'single1' ? 1 : weeks * weeklyFrequency;
            
            return {
                name: name,
                address: address,
                phone: phone,
                program: program,
                dayOfWeek: dayOfWeek,
                time: time,
                startDate: startDate,
                endDate: endDate,
                duration: duration,
                weeks: weeks,
                weeklyFrequency: weeklyFrequency,
                totalSessions: totalSessions,
                amount: amount
            };
        }
        
        function showSuccessModal(fileName) {
            // 기존 모달이 있으면 제거
            const existingModal = document.getElementById('successModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // body 스크롤 막기 (모바일에서 중요!)
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            
            // 모달 오버레이 생성
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'successModal';
            
            // 모달 콘텐츠 생성
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            // 아이콘
            const icon = document.createElement('div');
            icon.className = 'modal-icon';
            icon.textContent = '✅';
            
            // 타이틀
            const title = document.createElement('h2');
            title.className = 'modal-title';
            title.textContent = '신청 완료!';
            
            // 메시지
            const message = document.createElement('p');
            message.className = 'modal-message';
            message.textContent = '다음 달 아파트 관리비로 청구됩니다.';
            
            // 신청서 보기 버튼
            const viewBtn = document.createElement('button');
            viewBtn.className = 'modal-btn';
            viewBtn.textContent = '📄 신청서 보기';
            viewBtn.style.touchAction = 'manipulation'; // 터치 최적화
            viewBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('✅ 신청서 보기 버튼 클릭됨');
                viewApplication();
            };
            
            // 카카오 버튼
            const kakaoBtn = document.createElement('button');
            kakaoBtn.className = 'modal-btn secondary';
            kakaoBtn.textContent = '💬 문의 사항 있으신가요?';
            kakaoBtn.style.touchAction = 'manipulation'; // 터치 최적화
            kakaoBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('✅ 카카오 버튼 클릭됨');
                openKakaoChannel();
            };
            
            // DOM 조립 (순서대로)
            modalContent.appendChild(icon);
            modalContent.appendChild(title);
            modalContent.appendChild(message);
            modalContent.appendChild(viewBtn);
            modalContent.appendChild(kakaoBtn);
            modal.appendChild(modalContent);
            
            // body에 추가
            document.body.appendChild(modal);
            
            // 강제 리플로우 (레이아웃 재계산)
            modal.offsetHeight;
            
            // active 클래스 추가 (애니메이션)
            modal.classList.add('active');
        }
        
        // 안드로이드에서도 작동하는 신청서 보기
        function viewApplication() {
            console.log('📄 신청서 보기 클릭');
            
            // capturedBlob 존재 확인
            if (!capturedBlob) {
                console.error('❌ 캡처된 이미지가 없습니다');
                alert('신청서를 찾을 수 없습니다. 다시 시도해주세요.');
                return;
            }
            
            // 모바일 감지
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            console.log('📱 모바일:', isMobile, '/ 안드로이드:', isAndroid);
            
            if (isAndroid) {
                // 안드로이드: Base64 Data URL로 변환하여 열기
                console.log('📱 안드로이드: Base64로 변환 중...');
                
                const reader = new FileReader();
                reader.onloadend = function() {
                    const base64data = reader.result;
                    console.log('✅ Base64 변환 완료');
                    
                    // Data URL을 새 탭에서 열기
                    const newWindow = window.open('', '_blank');
                    if (newWindow) {
                        newWindow.document.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="UTF-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <title>신청서</title>
                                <style>
                                    body { 
                                        margin: 0; 
                                        padding: 0; 
                                        display: flex; 
                                        justify-content: center; 
                                        align-items: center;
                                        min-height: 100vh;
                                        background: #f5f5f5;
                                    }
                                    img { 
                                        max-width: 100%; 
                                        height: auto;
                                        display: block;
                                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                    }
                                </style>
                            </head>
                            <body>
                                <img src="${base64data}" alt="신청서">
                            </body>
                            </html>
                        `);
                        newWindow.document.close();
                    } else {
                        alert('팝업이 차단되었습니다.\n브라우저 설정에서 팝업을 허용해주세요.');
                    }
                };
                reader.readAsDataURL(capturedBlob);
                
            } else {
                // iOS 및 데스크탑: Blob URL 사용
                console.log('💻 iOS/데스크탑: Blob URL 사용');
                const url = URL.createObjectURL(capturedBlob);
                const newWindow = window.open(url, '_blank');
                
                if (!newWindow) {
                    alert('팝업이 차단되었습니다.\n브라우저 설정에서 팝업을 허용해주세요.');
                }
            }
        }
        
        function openKakaoChannel() {
            // 카카오톡 채널 URL (실제 채널 URL로 교체 필요)
            window.open('http://pf.kakao.com/_nVSxdn/chat', '_blank');
        }
        
        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            if (modal) {
                modal.classList.remove('active');
            }
            
            // body 스크롤 복원
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
        }
        
        function downloadToDevice() {
            const url = URL.createObjectURL(capturedBlob);
            const link = document.createElement('a');
            const name = document.getElementById('name').value || '신청자';
            const today = new Date();
            const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
            
            link.download = `커뮤니티센터_회원신청서_${name}_${dateStr}.png`;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            downloadedFileUrl = url;
        }
        
        function viewDownloadedFile() {
            if (downloadedFileUrl) {
                window.open(downloadedFileUrl, '_blank');
            }
        }
        
        function closeDownloadModal() {
            document.getElementById('downloadModal').classList.remove('active');
            if (downloadedFileUrl) {
                URL.revokeObjectURL(downloadedFileUrl);
            }
        }
    </script>
</body>
</html>
